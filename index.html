<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù…Ø§Ù† Ø±Ø§Ù…Ø§ Ù‡ÙˆÙ…â€ŒÙˆØ±Ú©</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Fonts (Vazirmatn) -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- Persian Date Library -->
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.min.js"></script>

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #F8F9FA;
        }
        .google-shadow {
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        .google-shadow:hover {
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
        }
        .g-blue { color: #4285F4; }
        .g-red { color: #EA4335; }
        .g-green { color: #34A853; }
        .g-yellow { color: #FBBC05; }
        
        .bg-g-blue { background-color: #4285F4; }
        .bg-g-red { background-color: #EA4335; }
        .bg-g-green { background-color: #34A853; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #999; }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background: #34A853; }
        .toast.error { background: #EA4335; }
        .toast.info { background: #4285F4; }
    </style>
</head>
<body class="text-gray-700">

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Navbar -->
    <nav class="bg-white shadow-md fixed w-full z-10 top-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">ğŸ“š</span>
                    <h1 class="text-xl font-bold text-gray-800 tracking-tight">Ø±Ø§Ù…Ø§ <span class="text-blue-500">Ù‡ÙˆÙ…â€ŒÙˆØ±Ú©</span> <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full mr-2 border border-gray-200">Ù¾Ù†Ù„ Ù…Ø¹Ù„Ù…Ø§Ù†</span></h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <button onclick="openSettings()" class="text-gray-500 hover:text-blue-500 transition">
                        âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                    </button>
                    <button id="connectionStatus" class="px-3 py-1 rounded-full text-xs font-bold bg-gray-200 text-gray-500">
                        Ø¢ÙÙ„Ø§ÛŒÙ†
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto pt-24 pb-12 px-4">
        
        <!-- Date Selection -->
        <div class="bg-white rounded-lg google-shadow p-6 mb-8 border-r-4 border-blue-500">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex flex-col">
                    <h2 class="text-lg font-bold flex items-center">
                        <span class="text-blue-500 ml-2">ğŸ“…</span> ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® Ø¨Ø±Ù†Ø§Ù…Ù‡
                    </h2>
                    <span class="text-xs text-gray-400 mt-1">ØªØ§Ø±ÛŒØ® Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ ÛŒØ§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</span>
                </div>
                <div class="flex flex-wrap gap-2 w-full md:w-auto items-center justify-end">
                    <input type="text" id="dateInput" placeholder="1403/09/09" class="text-center w-full md:w-40 border-2 border-gray-200 rounded-lg p-2 focus:border-blue-500 focus:outline-none transition font-bold text-lg text-gray-600 tracking-wider" dir="ltr">
                    
                    <button onclick="setToday()" class="bg-gray-100 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-200 transition whitespace-nowrap font-bold text-sm">Ø§Ù…Ø±ÙˆØ²</button>
                    <button onclick="setTomorrow()" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-100 transition whitespace-nowrap font-bold text-sm">ÙØ±Ø¯Ø§</button>
                    
                    <div class="h-8 w-px bg-gray-300 mx-1 hidden md:block"></div>
                    
                    <button onclick="loadPlan()" class="w-full md:w-auto bg-g-blue text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition shadow-md font-bold flex items-center justify-center gap-2">
                        <span>ğŸ“¥</span> Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Left Column: Form -->
            <div class="space-y-6">
                
                <!-- Add Homework/Exam Form -->
                <div class="bg-white rounded-lg google-shadow p-6 border-t-4 border-green-500">
                    <h3 class="text-lg font-bold mb-4 flex items-center text-gray-800">
                        <span class="text-green-500 ml-2">âœï¸</span> Ø«Ø¨Øª ØªÚ©Ù„ÛŒÙ / Ø§Ù…ØªØ­Ø§Ù†
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ù†ÙˆØ¹ ÙØ¹Ø§Ù„ÛŒØª</label>
                            <div class="flex gap-2">
                                <button onclick="setType('homework')" id="btn-homework" class="flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-bold transition-all">ØªÚ©Ù„ÛŒÙ ğŸ“š</button>
                                <button onclick="setType('exam')" id="btn-exam" class="flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-100 text-gray-500 hover:bg-gray-200 transition-all">Ø§Ù…ØªØ­Ø§Ù† ğŸ¯</button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ù†Ø§Ù… Ø¯Ø±Ø³</label>
                            <input type="text" id="subject" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø±ÛŒØ§Ø¶ÛŒ" class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-blue-500 focus:outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ØªÙˆØ¶ÛŒØ­Ø§Øª / ØµÙØ­Ø§Øª</label>
                            <textarea id="task" rows="3" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø­Ù„ ØªÙ…Ø±ÛŒÙ†â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ Û´Ûµ" class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-blue-500 focus:outline-none transition"></textarea>
                        </div>

                        <button onclick="addItem()" class="w-full bg-gray-800 text-white py-3 rounded-lg hover:bg-black transition font-bold shadow-lg flex justify-center items-center gap-2 transform active:scale-95">
                            <span>â•</span> Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª
                        </button>
                    </div>
                </div>

                <!-- Tip of the Day -->
                <div class="bg-white rounded-lg google-shadow p-6 border-t-4 border-yellow-400">
                    <h3 class="text-lg font-bold mb-4 flex items-center text-gray-800">
                        <span class="text-yellow-500 ml-2">ğŸ’¡</span> Ù¾ÛŒØ§Ù… Ù…Ø¹Ù„Ù… / Ù†Ú©ØªÙ‡ Ø±ÙˆØ²
                    </h3>
                    <textarea id="dailyTip" rows="2" placeholder="Ù¾ÛŒØ§Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†..." class="w-full border-2 border-gray-200 rounded-lg p-2 focus:border-yellow-400 focus:outline-none transition"></textarea>
                </div>
            </div>

            <!-- Right Column: Preview & List -->
            <div class="space-y-6">
                
                <!-- Live Preview Card -->
                <div class="bg-white rounded-lg google-shadow p-0 overflow-hidden">
                    <div class="bg-blue-50 p-4 border-b border-blue-100 flex justify-between items-center">
                        <h3 class="text-blue-600 font-bold flex items-center">
                            ğŸ‘ï¸ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…
                        </h3>
                        <span class="text-xs text-blue-400 bg-white px-2 py-1 rounded-full">ÙˆÛŒÙˆ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</span>
                    </div>
                    <div class="p-6 bg-gray-50">
                        <!-- Telegram Message Simulator -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-sm leading-relaxed" id="telegramPreview">
                            Loading...
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <button onclick="saveToSupabase()" id="saveBtn" class="w-full bg-g-blue text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-600 transition transform hover:-translate-y-1 flex justify-center items-center gap-2">
                    <span>ğŸ’¾</span> Ø§Ù†ØªØ´Ø§Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
                </button>
                <div class="text-center text-xs text-gray-400 mt-2">
                    Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‚Ø¨Ù„ÛŒ Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø²Ù†ÙˆÛŒØ³ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
                </div>

            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØªØµØ§Ù„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³</h2>
            <p class="text-sm text-gray-500 mb-4">
                Ù„Ø·ÙØ§ Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§Ù…Ø§ Ù‡ÙˆÙ…â€ŒÙˆØ±Ú© (Supabase) Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.
            </p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Supabase URL</label>
                    <input type="text" id="supaUrl" class="w-full border border-gray-300 rounded-lg p-2 text-left" dir="ltr" placeholder="https://xyz.supabase.co">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Supabase Anon Key</label>
                    <input type="password" id="supaKey" class="w-full border border-gray-300 rounded-lg p-2 text-left" dir="ltr" placeholder="eyJhbGci...">
                </div>
            </div>

            <div class="mt-8 flex gap-3">
                <button onclick="saveSettings()" class="flex-1 bg-g-blue text-white py-2 rounded-lg font-bold hover:bg-blue-600 transition">Ø°Ø®ÛŒØ±Ù‡ Ø§ØªØµØ§Ù„</button>
                <button onclick="closeSettings()" class="px-4 py-2 rounded-lg text-gray-500 hover:bg-gray-100 transition">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let supabase = null;
        let currentType = 'homework'; // homework or exam
        let currentPlan = {
            homework: [],
            exams: [],
            tip: ""
        };

        // --- Initialization ---
        window.onload = function() {
            loadSettings();
            setTomorrow(); // Default to tomorrow
            updatePreview();
            
            // Cleanup old tasks immediately on load
            setTimeout(cleanupOldTasks, 1000);
        };

        // --- UI Feedback (Toast) ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'â„¹ï¸';
            if (type === 'success') icon = 'âœ…';
            if (type === 'error') icon = 'âŒ';

            toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Supabase Connection ---
        function loadSettings() {
            const url = localStorage.getItem('rama_bot_url'); 
            const key = localStorage.getItem('rama_bot_key');

            if (!url) {
                // Backward compatibility
                const oldUrl = localStorage.getItem('school_bot_url');
                if (oldUrl) {
                    localStorage.setItem('rama_bot_url', localStorage.getItem('school_bot_url'));
                    localStorage.setItem('rama_bot_key', localStorage.getItem('school_bot_key'));
                    loadSettings(); 
                    return;
                }
            }

            if (url && key) {
                initSupabase(url, key);
                document.getElementById('supaUrl').value = url;
                document.getElementById('supaKey').value = key;
            } else {
                openSettings();
            }
        }

        function initSupabase(url, key) {
            try {
                supabase = window.supabase.createClient(url, key);
                document.getElementById('connectionStatus').innerText = "âœ… Ù…ØªØµÙ„";
                document.getElementById('connectionStatus').className = "px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-600";
            } catch (e) {
                console.error(e);
                document.getElementById('connectionStatus').innerText = "âŒ Ø®Ø·Ø§";
            }
        }

        function saveSettings() {
            const url = document.getElementById('supaUrl').value.trim();
            const key = document.getElementById('supaKey').value.trim();
            
            if(!url || !key) {
                showToast("Ù„Ø·ÙØ§ Ù‡Ø± Ø¯Ùˆ ÙÛŒÙ„Ø¯ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.", 'error');
                return;
            }

            localStorage.setItem('rama_bot_url', url);
            localStorage.setItem('rama_bot_key', key);
            
            initSupabase(url, key);
            closeSettings();
            showToast("ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯", 'success');
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // --- Date Logic ---
        function getJalaaliDate(offsetDays = 0) {
            const date = new Date();
            date.setDate(date.getDate() + offsetDays);
            const jDate = jalaali.toJalaali(date.getFullYear(), date.getMonth() + 1, date.getDate());
            const y = jDate.jy;
            const m = jDate.jm.toString().padStart(2, '0');
            const d = jDate.jd.toString().padStart(2, '0');
            return `${y}/${m}/${d}`;
        }

        function setToday() {
            document.getElementById('dateInput').value = getJalaaliDate(0);
            showToast("ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯");
            loadPlan(); // Auto reload for convenience
        }

        function setTomorrow() {
            document.getElementById('dateInput').value = getJalaaliDate(1);
            showToast("ØªØ§Ø±ÛŒØ® ÙØ±Ø¯Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯");
            loadPlan(); // Auto reload for convenience
        }

        function setType(type) {
            currentType = type;
            const btnHw = document.getElementById('btn-homework');
            const btnEx = document.getElementById('btn-exam');

            if (type === 'homework') {
                btnHw.className = "flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-bold transition transform scale-105";
                btnEx.className = "flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-100 text-gray-500 hover:bg-gray-200 transition";
            } else {
                btnEx.className = "flex-1 py-2 rounded-lg border-2 border-red-500 bg-red-50 text-red-700 font-bold transition transform scale-105";
                btnHw.className = "flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-100 text-gray-500 hover:bg-gray-200 transition";
            }
        }

        // --- Cleanup Logic (NEW) ---
        async function cleanupOldTasks() {
            if (!supabase) return;

            const todayStr = getJalaaliDate(0);
            
            console.log("Cleaning up plans before:", todayStr);
            
            // Call the database function
            const { error } = await supabase.rpc('delete_old_plans', { 
                current_date_text: todayStr 
            });

            if (error) {
                console.error("Cleanup Error:", error);
            } else {
                console.log("Old tasks cleaned successfully.");
            }
        }

        // --- Data Logic ---
        async function loadPlan() {
            if (!supabase) { openSettings(); return; }
            
            const dateStr = document.getElementById('dateInput').value;
            const btn = document.querySelector('button[onclick="loadPlan()"] span');
            
            // Simple validation for date format
            if (!/^\d{4}\/\d{2}\/\d{2}$/.test(dateStr)) {
                showToast("ÙØ±Ù…Øª ØªØ§Ø±ÛŒØ® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (Ù…Ø«Ø§Ù„: 1403/09/09)", 'error');
                return;
            }

            const originalIcon = btn.innerText;
            btn.innerText = "â³";

            const { data, error } = await supabase
                .from('daily_plans')
                .select('*')
                .eq('date', dateStr)
                .single();

            if (error && error.code !== 'PGRST116') { 
                console.error('Error:', error);
                showToast("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª", 'error');
            } else if (data) {
                currentPlan = data;
                if (!currentPlan.homework) currentPlan.homework = [];
                if (!currentPlan.exams) currentPlan.exams = [];
                document.getElementById('dailyTip').value = currentPlan.tip || "";
                showToast("Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ® Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯", 'success');
            } else {
                currentPlan = { homework: [], exams: [], tip: "" };
                document.getElementById('dailyTip').value = "";
                showToast("Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ§Ø±ÛŒØ® ÛŒØ§ÙØª Ù†Ø´Ø¯ (Ø¬Ø¯ÛŒØ¯)", 'info');
            }

            updatePreview();
            btn.innerText = originalIcon;
        }

        function addItem() {
            const subject = document.getElementById('subject').value.trim();
            const task = document.getElementById('task').value.trim();

            if (!subject) {
                showToast("Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯", 'error');
                return;
            }

            if (currentType === 'homework') {
                currentPlan.homework.push({ subject, task });
            } else {
                currentPlan.exams.push({ subject, type: task || "Ø§Ù…ØªØ­Ø§Ù†" });
            }

            document.getElementById('subject').value = "";
            document.getElementById('task').value = "";
            document.getElementById('subject').focus();

            updatePreview();
            showToast("Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯", 'success');
        }

        function removeItem(type, index) {
            // No confirm for faster workflow, user can re-add if mistake, or we assume teacher knows what they do
            if (type === 'homework') {
                currentPlan.homework.splice(index, 1);
            } else {
                currentPlan.exams.splice(index, 1);
            }
            updatePreview();
            showToast("Ø¢ÛŒØªÙ… Ø­Ø°Ù Ø´Ø¯", 'info');
        }

        // --- Preview Rendering ---
        function updatePreview() {
            const dateStr = document.getElementById('dateInput').value;
            const tip = document.getElementById('dailyTip').value;
            currentPlan.tip = tip; 

            let html = `<div class="font-bold text-blue-600 mb-2">ğŸ”µ ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ - ${dateStr}</div>`;
            html += `<div class="text-gray-300 mb-2">â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</div>`;

            // Homework
            html += `<div class="font-bold text-green-600 mb-1">ğŸŸ¢ ğŸ“š ØªÚ©Ø§Ù„ÛŒÙ:</div>`;
            if (currentPlan.homework.length > 0) {
                currentPlan.homework.forEach((hw, idx) => {
                    html += `<div class="flex justify-between items-start group bg-blue-50/50 p-1 rounded mb-1 hover:bg-blue-100 transition">
                                <span class="text-sm">â€¢ <span class="text-blue-600 font-bold">${hw.subject}</span>: ${hw.task}</span>
                                <button onclick="removeItem('homework', ${idx})" class="text-red-500 font-bold px-2 py-0.5 rounded hover:bg-red-100 text-xs border border-red-200 ml-2" title="Ø­Ø°Ù">âŒ</button>
                             </div>`;
                });
            } else {
                html += `<div class="text-gray-400 text-xs italic">â€¢ Ù‡ÛŒÚ† ØªÚ©Ù„ÛŒÙÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</div>`;
            }

            html += `<br>`;

            // Exams
            if (currentPlan.exams.length > 0) {
                html += `<div class="font-bold text-yellow-600 mb-1">ğŸŸ¡ ğŸ¯ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª/Ú©ÙˆÛŒÛŒØ²Ù‡Ø§:</div>`;
                currentPlan.exams.forEach((ex, idx) => {
                    html += `<div class="flex justify-between items-start group bg-yellow-50/50 p-1 rounded mb-1 hover:bg-yellow-100 transition">
                                <span class="text-sm">â€¢ <span class="text-red-600 font-bold">${ex.subject}</span>: ${ex.type}</span>
                                <button onclick="removeItem('exams', ${idx})" class="text-red-500 font-bold px-2 py-0.5 rounded hover:bg-red-100 text-xs border border-red-200 ml-2" title="Ø­Ø°Ù">âŒ</button>
                             </div>`;
                });
                html += `<br>`;
            }

            // Tip
            if (currentPlan.tip) {
                html += `<div class="font-bold text-yellow-600 mb-1">ğŸŸ¡ ğŸ’¡ Ù†Ú©ØªÙ‡ Ø±ÙˆØ²:</div>`;
                html += `<div class="italic text-gray-600 text-sm">"${currentPlan.tip}"</div><br>`;
            }

            html += `<div class="text-gray-500 text-sm">âœ¨ Ø±ÙˆØ² Ù¾Ø±Ø¨Ø§Ø±ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯! ğŸš€</div>`;

            document.getElementById('telegramPreview').innerHTML = html;
        }

        document.getElementById('dailyTip').addEventListener('input', updatePreview);
        document.getElementById('dateInput').addEventListener('input', updatePreview);

        // --- Save Logic ---
        async function saveToSupabase() {
            if (!supabase) { openSettings(); return; }

            const saveBtn = document.getElementById('saveBtn');
            const dateStr = document.getElementById('dateInput').value;

            if (!dateStr) { showToast("Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯", 'error'); return; }

            saveBtn.disabled = true;
            saveBtn.innerHTML = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³...";
            saveBtn.classList.add('opacity-75');

            const payload = {
                date: dateStr,
                homework: currentPlan.homework,
                exams: currentPlan.exams,
                tip: currentPlan.tip
            };

            const { error } = await supabase
                .from('daily_plans')
                .upsert(payload, { onConflict: 'date' });

            saveBtn.disabled = false;
            saveBtn.classList.remove('opacity-75');

            if (error) {
                console.error(error);
                saveBtn.innerHTML = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡";
                saveBtn.classList.add('bg-red-500');
                showToast("Ø§Ø±ÙˆØ±: " + error.message, 'error');
                
                setTimeout(() => {
                    saveBtn.innerHTML = "ğŸ’¾ Ø§Ù†ØªØ´Ø§Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³";
                    saveBtn.classList.remove('bg-red-500');
                }, 3000);
            } else {
                saveBtn.innerHTML = "âœ… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯";
                saveBtn.classList.add('bg-green-500');
                showToast("Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯", 'success');
                
                setTimeout(() => {
                    saveBtn.innerHTML = "ğŸ’¾ Ø§Ù†ØªØ´Ø§Ø± Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³";
                    saveBtn.classList.remove('bg-green-500');
                }, 2000);
            }
        }
    </script>
</body>
</html>
